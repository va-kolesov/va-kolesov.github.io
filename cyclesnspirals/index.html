<canvas id="fractal"></canvas>
<style>
    body {
        margin: 0;
        overflow: hidden;
        background: #000;
    }
    canvas {
        width: 100vw;
        height: 100vh;
        display: block;
    }
</style>
<script src="https://unpkg.com/noisejs@2.1.0/index.js"></script>
<script>
    function clearPattern(t,e,a){return Math.sin(Math.sqrt(t**2+e**2)*(8+20*Math.sin(5*a))+6*Math.atan2(e,t)+2*a*Math.PI)}function fractalNoise(t,e,a,s=7){let n=0,i=1,o=1,r=0,h=1/s;for(let l=0;l<s;l++){let c=l===s-1?1-a:0===l?a:1,u=Math.PI*(l+a)*2*h,d=Math.sin(u),m=Math.cos(u),f=t*d+e*m,g=t*m-e*d,M=i*c;n+=(.5*noise.simplex2(f*o+5,g*o+5)+.5)**2*M,r+=M,i*=.5,o*=2}return(n/r)**.5}function hslToRgb(t,e,a){let s,n,i;if(t/=360,a/=100,0===(e/=100))s=n=i=a;else{let o=(t,e,a)=>(a<0&&(a+=1),a>1&&(a-=1),a<1/6?t+6*(e-t)*a:a<.5?e:a<2/3?t+(e-t)*(2/3-a)*6:t),r=a<.5?a*(1+e):a+e-a*e,h=2*a-r;s=o(h,r,t+1/3),n=o(h,r,t),i=o(h,r,t-1/3)}return[Math.round(255*s),Math.round(255*n),Math.round(255*i)]}function lerp(t,e,a){return t*(1-a)+e*a}function clamp(t){return t>1?1:t<0?0:t}function getCustomWave(t,e){let a=e.length,s=new Float32Array(a/2+1),n=new Float32Array(a/2+1);for(let t=0;t<s.length;t++){let i=0,o=0;for(let s=0;s<a;s++){let n=2*Math.PI*t*s/a;i+=e[s]*Math.cos(n),o+=e[s]*Math.sin(n)}s[t]=i/a,n[t]=-o/a}return t.createPeriodicWave(s,n,{disableNormalization:!1})}function getNoiseSamples(){let t=new Float32Array(1024);for(let e=0;e<t.length;e++)t.length,t[e]=2*Math.random()-1;return t}function getOscillator(t,e){let a=t.createOscillator();switch(e){case"sine":case"triangle":case"sawtooth":case"square":a.type=e;break;case"noise":{let e=getCustomWave(t,getNoiseSamples());a.setPeriodicWave(e)}}return a}window.noise=new Noise(2);class AudioSystem{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.merger=this.context.createChannelMerger(2),this.oscillators=[],this.gains=[],this.notes=[],this.initOscillators(),this.initNotes(),this.connectNodes()}initOscillators(){let t=["sine","triangle","noise"];this.oscillators=Array.from({length:3},((e,a)=>{let s=getOscillator(this.context,t[a%t.length]),n=this.context.createGain(),i=new StereoPannerNode(this.context,{pan:0});return s.frequency.value=0,n.gain.value=0,s.connect(n),n.connect(i),i.connect(this.merger),this.gains.push(n),s.start(),s}))}initNotes(){this.notes=Array.from({length:24},((t,e)=>55*1.0594630943592953**e)).filter(((t,e)=>[0,2,3,5,7,8,10].includes(e%12)))}connectNodes(){this.merger.connect(this.analyser),this.analyser.connect(this.context.destination)}playPluckSound(t){let{frequency:e,duration:a,decay:s,volume:n,attack:i,offset:o,oscillator:r,gainNode:h}=t,l=this.context.currentTime+o;r.frequency.setValueAtTime(e,l),h.gain.setValueAtTime(1e-4,l),h.gain.exponentialRampToValueAtTime(n,l+i),h.gain.exponentialRampToValueAtTime(1e-4,l+a)}}class FractalRenderer{constructor(){this.canvas=document.getElementById("fractal"),this.ctx=this.canvas.getContext("2d"),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.noise=new Noise(1),this.maxRes=320,this.scaleRes=6,this.initEventListeners(),this.resize()}initEventListeners(){window.addEventListener("resize",(()=>this.resize()))}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.scaleRes=Math.max(Math.max(this.canvas.width,this.canvas.height)/this.maxRes,2),this.offscreenCanvas.width=Math.floor(this.canvas.width/this.scaleRes),this.offscreenCanvas.height=Math.floor(this.canvas.height/this.scaleRes)}generateFractalFrame(t){let e=10*t%1,{width:a,height:s}=this.offscreenCanvas,n=a/s,i=this.offscreenCtx.createImageData(a,s),o=i.data,r=2**e,h=.5*Math.sin(2*Math.PI*t/3)+.5,l=.5*Math.cos(2*Math.PI*t/7)+.5,c=4*r,u=a/2,d=s/2;for(let i=0;i<s;i+=1){let m=(i-d)/s*c/n;for(let s=0;s<a;s+=1){let n=(s-u)/a*c,d=fractalNoise(n,m,e,4)/4,f=fractalNoise(n-Math.sin(d*Math.PI*2)/2*h,m-Math.cos(d*Math.PI*2)/2*h,e)**4,g=clearPattern(n/c+Math.cos(d*Math.PI*2)/4*h,m/c+Math.sin(d*Math.PI*2)/4*h,t-d/200)**4,M=lerp(g,f,h**2),y=720*(M+.5*r)%360,[v,w,S]=hslToRgb(y,100*l,40*g+40);o[i*a*4+4*s+0]=v>w*M?v:S,o[i*a*4+4*s+1]=w>S*f?w:v,o[i*a*4+4*s+2]=S>v*g?S:w,o[i*a*4+4*s+3]=255}}return this.offscreenCtx.putImageData(i,0,0),this.ctx.imageSmoothingEnabled=!1,this.ctx.drawImage(this.offscreenCanvas,0,0,this.canvas.width,this.canvas.height),i}}class SoundProcessor{constructor(t){this.audioSystem=t}generateSoundData(t){let e=[];for(let t=0;t<this.audioSystem.oscillators.length;t++)e.push([]);let a=10*t%1,s=.5*Math.sin(2*Math.PI*t/3)+.5,n=4*2**a;for(let i=0;i<e.length;i+=1){let o=(i+.5)/e.length,r=0,h=0,l=0;for(let c=0;c<1023;c+=1){let u=(c-512)/1024*n,d=fractalNoise(u,o,a,4)/4,m=((clearPattern(u/n-Math.cos(d*Math.PI*2)/4*s,o/n-Math.sin(d*Math.PI*2)/4*s,t-d/200)+1)/2)**2,f=fractalNoise(u-Math.cos(d*Math.PI*2)/2*s,o-Math.sin(d*Math.PI*2)/2*s,a)**4,g=lerp(m,f,s**2);if(Math.abs(l-g)>.1&&r>1024*(1-s/2)/5){l=g,h++;let t=Math.max(r/1024,1/8);e[i].push({duration:t,noteIndex:14*m|0,frequency:2**i*this.audioSystem.notes[14*m|0]+100*f*s,attack:.05,decay:.5}),r=0}else r++}}return e}playSound(t,e){t.forEach(((t,a)=>{this.playNoteSequence(this.audioSystem.oscillators[a],a,t,e/1e3)}))}playNoteSequence(t,e,a,s){let n=this.audioSystem.gains[e],i="custom"===t.type,o=e/this.audioSystem.oscillators.length*s;a.forEach((({noteIndex:r,frequency:h,attack:l,duration:c,decay:u},d)=>{o+=i?1/a.length*s:c*s,c=i?.1:c/2*s,l=i?.01:l*s,u=i?.05:c-l-.05*s,this.audioSystem.playPluckSound({offset:o,frequency:i?4**(r%3+1):h,volume:i?1:.1+.3*e,oscillator:t,gainNode:n,duration:c,attack:l,decay:u})}))}}class AnimationController{constructor(){this.timeScale=1e-5,this.frameInterval=1e3/60,this.soundIntervalMs=3e3,this.lastTime=0,this.lastSound=0,this.audioSystem=new AudioSystem,this.renderer=new FractalRenderer,this.soundProcessor=new SoundProcessor(this.audioSystem)}start(){this.animate(),this.setupAudioActivation()}setupAudioActivation(){this.renderer.canvas.addEventListener("click",(()=>{this.audioSystem.context.resume().then((()=>{console.log("Audio activated")}))}))}animate(t=0){if(t-this.lastTime<this.frameInterval)requestAnimationFrame((t=>this.animate(t)));else{try{let e=Date.now()*this.timeScale;if(this.renderer.generateFractalFrame(e),t-this.lastSound>this.soundIntervalMs){let a=this.soundProcessor.generateSoundData(e);this.soundProcessor.playSound(a,this.soundIntervalMs),this.lastSound=t}}catch(t){}this.lastTime=t,requestAnimationFrame((t=>this.animate(t)))}}}const controller=new AnimationController;controller.start();
</script>
